<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <title>StyleGenie — подбор образов и ателье</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>/* StyleGenie — статическая версия для GitHub Pages */
:root {
  --font-inter: 'Inter', system-ui, sans-serif;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --black: #000000;
  --white: #ffffff;
}

* {
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: var(--font-inter);
  font-size: 15px;
  color: var(--gray-900);
  background: var(--white);
  -webkit-font-smoothing: antialiased;
  display: flex;
  flex-direction: column;
}

/* Header */
.header {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(229, 231, 235, 0.8);
}

.header-title {
  margin: 0;
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--gray-900);
}

.header-nav {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--gray-600);
}


.header-nav a {
  color: inherit;
  text-decoration: none;
  white-space: nowrap;
}

.header-nav a:hover {
  color: var(--gray-900);
}

/* Main */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.main.has-content {
  justify-content: flex-start;
}

.main:not(.has-content) {
  justify-content: center;
  align-items: center;
  padding: 32px 16px;
}

/* Empty state */
.empty-state {
  width: 100%;
  max-width: 56rem;
  margin: 0 auto;
  text-align: center;
  position: relative;
}

.empty-state-content {
  position: relative;
  z-index: 1;
  max-width: 48rem;
  margin: 0 auto;
}

/* Фигурки по бокам — вылетают к середине при загрузке */
.figurines-wrap {
  position: absolute;
  left: -6%;
  right: -6%;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  padding: 0;
  pointer-events: none;
  z-index: 0;
  opacity: 1;
  visibility: visible;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

.figurines-wrap.figurines-hidden {
  opacity: 0;
  visibility: hidden;
}

.figurine {
  flex-shrink: 0;
  width: 273px;
}

@media (min-width: 768px) {
  .figurine {
    width: 364px;
  }
}

.figurine img {
  width: 100%;
  height: auto;
  display: block;
}

/* Девушка слева — чуть ниже, вылет с анимацией */
.figurine-left {
  align-self: flex-end;
  margin-bottom: -2%;
  margin-right: -3%;
  opacity: 0;
  animation: figurineFlyInLeft 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

/* Парень справа — выше, вылет с анимацией */
.figurine-right {
  align-self: flex-end;
  margin-bottom: 8%;
  margin-left: -3%;
  opacity: 0;
  animation: figurineFlyInRight 1s cubic-bezier(0.22, 1, 0.36, 1) 0.1s forwards;
}

@keyframes figurineFlyInLeft {
  from {
    opacity: 0;
    transform: translateX(-140px) scale(0.85);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

@keyframes figurineFlyInRight {
  from {
    opacity: 0;
    transform: translateX(140px) scale(0.85);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

.empty-title {
  margin: 0 0 32px;
  font-size: 1.5rem;
  font-weight: 500;
  color: var(--gray-800);
}

@media (min-width: 768px) {
  .empty-title {
    font-size: 1.875rem;
  }
}

.input-bar-wrap {
  width: 100%;
  max-width: 48rem;
  margin: 0 auto;
}

.preview-wrap {
  position: relative;
  display: inline-block;
  width: 64px;
  height: 64px;
  margin-bottom: 8px;
  border-radius: 8px;
  overflow: hidden;
}

.preview-wrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-remove {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 16px;
  height: 16px;
  padding: 0;
  border: none;
  border-radius: 50%;
  background: var(--gray-700);
  color: var(--white);
  font-size: 12px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview-wrap-inline {
  margin-bottom: 8px;
}

/* Input form */
.input-form {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border-radius: 1rem;
  border: 1px solid var(--gray-200);
  background: var(--white);
  box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);
  transition: border-color 0.2s;
}

.input-form:hover {
  border-color: var(--gray-300);
}

.input-form input[type="text"] {
  flex: 1;
  min-width: 0;
  padding: 0;
  border: none;
  background: transparent;
  font-size: 15px;
  color: var(--gray-900);
  outline: none;
}

.input-form input[type="text"]::placeholder {
  color: var(--gray-400);
}

.hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}

.btn-icon {
  flex-shrink: 0;
  width: 36px;
  height: 36px;
  padding: 0;
  border: none;
  border-radius: 50%;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  color: var(--gray-500);
}

.btn-icon:hover {
  background: var(--gray-100);
  color: var(--gray-700);
}

.btn-icon svg {
  display: block;
}

.btn-send {
  flex-shrink: 0;
  width: 36px;
  height: 36px;
  padding: 0;
  border: none;
  border-radius: 50%;
  background: var(--black);
  color: var(--white);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
}

.btn-send svg {
  stroke: currentColor;
}

.btn-send:hover:not(:disabled) {
  opacity: 0.9;
}

.btn-send:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Chat wrap */
.chat-wrap {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.messages-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 24px 16px;
}

.messages-inner {
  max-width: 48rem;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* Message bubble */
.msg {
  display: flex;
  max-width: 85%;
}

.msg.user {
  align-self: flex-end;
  justify-content: flex-end;
}

.msg.assistant {
  align-self: flex-start;
  justify-content: flex-start;
}

.msg-bubble {
  max-width: 100%;
  padding: 16px 20px;
  border-radius: 1rem;
  font-size: 15px;
  font-weight: 500;
  line-height: 1.4;
}

.msg.user .msg-bubble {
  background: var(--gray-900);
  color: var(--white);
}

.msg.assistant .msg-bubble {
  background: var(--gray-100);
  color: var(--gray-900);
  border: 1px solid var(--gray-200);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.msg-bubble .msg-image {
  width: 112px;
  height: 112px;
  margin-bottom: 8px;
  border-radius: 8px;
  overflow: hidden;
}

.msg-bubble .msg-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.msg-content {
  margin: 0;
}

/* Product / Master cards */
.cards-group {
  margin-top: 16px;
}

.cards-group + .cards-group {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid var(--gray-300);
}

.cards-group-title {
  margin: 0 0 12px;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-800);
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

@media (min-width: 640px) {
  .cards-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

.card {
  border-radius: 1rem;
  overflow: hidden;
  border: 1px solid var(--gray-200);
}

.card-image-wrap {
  position: relative;
  width: 100%;
  aspect-ratio: 3 / 4;
  overflow: hidden;
}

.card-image-wrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.card-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 4px 8px;
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.6);
  color: var(--white);
  font-size: 12px;
}

.card-link {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-700);
  text-decoration: none;
  font-size: 14px;
  transition: background 0.2s;
}

.card-link:hover {
  background: var(--white);
}

.card-thumbs {
  display: flex;
  gap: 6px;
  padding: 6px;
  border-top: 1px solid var(--gray-200);
  overflow-x: auto;
}

.card-thumb {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--gray-200);
}

.card-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.card-body {
  padding: 12px;
  border-top: 1px solid var(--gray-200);
  background: var(--white);
}

.card-title {
  margin: 0;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-900);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-brand {
  margin: 2px 0 0;
  font-size: 12px;
  color: var(--gray-500);
}

.card-price {
  margin: 4px 0 0;
  font-size: 1rem;
  font-weight: 700;
  color: var(--gray-900);
}

/* Quick replies */
.quick-replies {
  margin-top: 12px;
}

.quick-replies-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.quick-reply-btn {
  padding: 8px 12px;
  border: none;
  border-radius: 12px;
  background: var(--gray-900);
  color: var(--white);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}

.quick-reply-btn:hover {
  background: var(--gray-800);
}

.quick-reply-discount-wrap {
  margin-top: 12px;
  padding-top: 8px;
  border-top: 1px solid var(--gray-300);
}

.quick-reply-discount-btn {
  padding: 10px 16px;
  border: none;
  border-radius: 12px;
  background: var(--gray-900);
  color: var(--white);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  width: 100%;
}

@media (min-width: 640px) {
  .quick-reply-discount-btn {
    width: auto;
  }
}

/* Loading */
.loading-bubble {
  display: flex;
  justify-content: flex-start;
  max-width: 48rem;
  margin: 0 auto 24px;
}

.loading-bubble-inner {
  padding: 12px 16px;
  border-radius: 1rem;
  background: var(--gray-100);
  border: 1px solid var(--gray-200);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--gray-300);
  border-top-color: var(--gray-500);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* Input bar fixed */
.input-bar-fixed {
  flex-shrink: 0;
  padding: 16px;
  border-top: 1px solid rgba(229, 231, 235, 0.8);
  background: var(--white);
}

.input-bar-fixed .input-form {
  max-width: 48rem;
  margin: 0 auto;
}

/* Footer */
.footer {
  flex-shrink: 0;
  padding: 8px 16px;
  text-align: center;
  font-size: 12px;
  color: var(--gray-400);
}

/* Line clamp helper */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
  <script>
    (function() {
      var p = document.location.pathname || '';
      if (document.location.protocol !== 'file:' && p && !p.endsWith('/')) {
        var b = document.createElement('base');
        b.href = document.location.origin + p + '/';
        document.head.appendChild(b);
      }
    })();
  </script>
</head>
<body>
  <header class="header">
    <h1 class="header-title">StyleGenie</h1>
    <nav class="header-nav">
      <a href="#">Маркетплейсы</a>
      <a href="#">Мои образы</a>
    </nav>
  </header>

  <main class="main" id="main">
    <!-- Пустое состояние: по центру, с фигурками по бокам -->
    <section class="empty-state" id="emptyState">
      <div class="figurines-wrap" id="figurinesWrap">
        <div class="figurine figurine-left" id="figurineLeft" aria-hidden="true">
          <img src="images/figurine-left.png" alt="">
        </div>
        <div class="figurine figurine-right" id="figurineRight" aria-hidden="true">
          <img src="images/figurine-right.png" alt="">
        </div>
      </div>
      <div class="empty-state-content">
        <h2 class="empty-title">Опиши, какой образ ты хочешь найти</h2>
        <div class="input-bar-wrap">
          <div class="preview-wrap" id="previewWrap" style="display: none;">
            <img id="previewImg" src="" alt="">
            <button type="button" class="preview-remove" id="previewRemove" aria-label="Убрать">×</button>
          </div>
          <form class="input-form" id="inputForm" onsubmit="return (window.__stylegenieSend && window.__stylegenieSend(0)) || false;">
            <input type="file" id="fileInput" accept="image/*" class="hidden">
            <input type="text" id="textInput" placeholder="Опиши образ или прикрепи картинку..." autocomplete="off" onkeydown="if(event.key==='Enter'){ event.preventDefault(); if(window.__stylegenieSend) window.__stylegenieSend(0); return false; }">
            <button type="button" class="btn-icon btn-icon-image" id="btnImage" aria-label="Прикрепить картинку">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
            </button>
            <button type="button" class="btn-send" id="btnSend" aria-label="Отправить" onclick="return (window.__stylegenieSend && window.__stylegenieSend(0)) || false;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
          </form>
        </div>
      </div>
    </section>

    <!-- Режим чата -->
    <section class="chat-wrap" id="chatWrap" style="display: none;">
      <div class="messages-wrap">
        <div class="messages-inner" id="messagesInner"></div>
        <div class="loading-bubble" id="loadingBubble" style="display: none;">
          <div class="loading-bubble-inner"><span class="spinner"></span></div>
        </div>
        <div id="messagesEnd"></div>
      </div>
      <div class="input-bar-fixed">
        <div class="preview-wrap preview-wrap-inline" id="previewWrapChat" style="display: none;">
          <img id="previewImgChat" src="" alt="">
          <button type="button" class="preview-remove" id="previewRemoveChat">×</button>
        </div>
        <form class="input-form" id="inputFormChat" onsubmit="return (window.__stylegenieSend && window.__stylegenieSend(1)) || false;">
          <input type="file" id="fileInputChat" accept="image/*" class="hidden">
          <input type="text" id="textInputChat" placeholder="Напиши сообщение..." autocomplete="off" onkeydown="if(event.key==='Enter'){ event.preventDefault(); if(window.__stylegenieSend) window.__stylegenieSend(1); return false; }">
          <button type="button" class="btn-icon btn-icon-image" id="btnImageChat" aria-label="Прикрепить картинку">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          </button>
          <button type="button" class="btn-send" id="btnSendChat" aria-label="Отправить" onclick="return (window.__stylegenieSend && window.__stylegenieSend(1)) || false;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
          </button>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    StyleGenie может показывать товары с маркетплейсов. Проверяйте актуальность на сайтах продавцов.<br>
    <small>На этом хостинге (GitHub Pages) нет сервера — ответы и «поиск» работают в браузере по демо-данным.</small>
  </footer>

<script>
window.__stylegenieSend = function(isChat) {
  try {
    if (window.__stylegenieDoSend) return window.__stylegenieDoSend(isChat);
  } catch (e) {}
  var inp = document.getElementById(isChat ? 'textInputChat' : 'textInput');
  var text = (inp && inp.value) ? inp.value.trim() : '';
  if (!text) return false;
  var area = document.getElementById('messagesInner');
  var main = document.getElementById('main');
  var empty = document.getElementById('emptyState');
  var chat = document.getElementById('chatWrap');
  function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  if (area) {
    area.innerHTML += '<div class="msg user"><div class="msg-bubble"><p class="msg-content">' + esc(text) + '</p></div></div>';
    area.innerHTML += '<div class="msg assistant"><div class="msg-bubble"><p class="msg-content">Понял! Уточни ценовой сегмент:</p><div class="quick-replies"><div class="quick-replies-buttons"><button type="button" class="quick-reply-btn" data-action="budget">До 10 000 ₽</button><button type="button" class="quick-reply-btn" data-action="mid">10 000 – 30 000 ₽</button><button type="button" class="quick-reply-btn" data-action="premium_mid">30 000 – 50 000 ₽</button><button type="button" class="quick-reply-btn" data-action="premium">Премиум 50 000+ ₽</button><button type="button" class="quick-reply-btn" data-action="discounts">Искать скидки</button></div></div></div></div>';
  }
  if (main) main.classList.add('has-content');
  if (empty) empty.style.display = 'none';
  if (chat) chat.style.display = 'flex';
  if (inp) inp.value = '';
  return false;
};
(function () {
  'use strict';

  // ——— Данные ———
  var MARKETPLACES = [
    { id: 'lamoda', name: 'Lamoda', url: 'https://www.lamoda.ru', enabled: true },
    { id: 'tsum', name: 'ЦУМ', url: 'https://www.tsum.ru', enabled: true },
    { id: 'wildberries', name: 'Wildberries', url: 'https://www.wildberries.ru', enabled: true },
    { id: 'ozon', name: 'Ozon', url: 'https://www.ozon.ru', enabled: true },
  ];

  var DRESS_IMAGES = [
    'https://images.unsplash.com/photo-1595777457583-95e059d581b8?w=400&h=533&fit=crop',
    'https://images.unsplash.com/photo-1566174053879-31528523f8ae?w=400&h=533&fit=crop',
    'https://images.unsplash.com/photo-1572804013309-59a88b7e92f1?w=400&h=533&fit=crop',
    'https://images.unsplash.com/photo-1515372039744-b8f02a3ae446?w=400&h=533&fit=crop',
    'https://images.unsplash.com/photo-1496747611176-843222e1e57c?w=400&h=533&fit=crop',
    'https://images.unsplash.com/photo-1585487000143-668a2d34c32f?w=400&h=533&fit=crop',
  ];

  var MOCK_MASTERS = [
    { id: 'm1', name: 'Ателье «Подиум»', image: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=533&fit=crop', priceFrom: 15000, priceTo: 45000 },
    { id: 'm2', name: 'Мастерская Ольги К.', image: 'https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=400&h=533&fit=crop', priceFrom: 8000, priceTo: 25000 },
    { id: 'm3', name: 'Ателье «Ткани и форма»', image: 'https://images.unsplash.com/photo-1558171813-4c088753af8f?w=400&h=533&fit=crop', priceFrom: 25000, priceTo: 80000 },
  ];

  var PRICE_OPTIONS = [
    { value: 'budget', label: 'До 10 000 ₽' },
    { value: 'mid', label: '10 000 – 30 000 ₽' },
    { value: 'premium_mid', label: '30 000 – 50 000 ₽' },
    { value: 'premium', label: 'Премиум 50 000+ ₽' },
    { value: 'discounts', label: 'Искать скидки' },
  ];

  var OCCASION_OPTIONS = [
    { value: 'casual', label: 'Повседневная одежда' },
    { value: 'office', label: 'Офис / деловой стиль' },
    { value: 'party', label: 'Вечеринка / выход' },
    { value: 'formal', label: 'Торжество / свадьба' },
    { value: 'any', label: 'Не важно' },
  ];

  var PLACEHOLDER_IMG = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="300" height="400"%3E%3Crect fill="%23f3f4f6" width="300" height="400"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="%239ca3af" font-size="16"%3EНет фото%3C/text%3E%3C/svg%3E';

  function generateMockProducts(marketplace, query) {
    var q = query || 'платье';
    return [
      { id: marketplace.id + '-1', name: 'Элегантное платье ' + q, price: 5000 + Math.floor(Math.random() * 50000), image: DRESS_IMAGES[0], images: [DRESS_IMAGES[0], DRESS_IMAGES[3], DRESS_IMAGES[4]], url: marketplace.url + '/product/1', marketplace: marketplace.name, similarity: 0.85 + Math.random() * 0.1, brand: 'Fashion Brand' },
      { id: marketplace.id + '-2', name: 'Стильное платье ' + q, price: 5000 + Math.floor(Math.random() * 50000), image: DRESS_IMAGES[1], images: [DRESS_IMAGES[1], DRESS_IMAGES[4]], url: marketplace.url + '/product/2', marketplace: marketplace.name, similarity: 0.75 + Math.random() * 0.1, brand: 'Style Brand' },
      { id: marketplace.id + '-3', name: 'Классическое платье ' + q, price: 5000 + Math.floor(Math.random() * 50000), image: DRESS_IMAGES[2], images: [DRESS_IMAGES[2], DRESS_IMAGES[5], DRESS_IMAGES[0]], url: marketplace.url + '/product/3', marketplace: marketplace.name, similarity: 0.65 + Math.random() * 0.1 },
    ];
  }

  function mockSearch(prompt) {
    var enabled = MARKETPLACES.filter(function (m) { return m.enabled; });
    var all = [];
    enabled.forEach(function (m) {
      all = all.concat(generateMockProducts(m, prompt));
    });
    all.sort(function (a, b) { return (b.similarity || 0) - (a.similarity || 0); });
    return all.slice(0, 6);
  }

  // ——— Состояние ———
  var state = {
    step: 'welcome',
    messages: [],
    userDescription: '',
    userImageUrl: null,
    userFilters: {},
    isLoading: false,
    selectedImage: null,
  };

  var messagesInner, loadingBubble, emptyState, chatWrap, main;
  var textInput, textInputChat, fileInput, fileInputChat;
  var previewWrap, previewWrapChat, previewImg, previewImgChat;
  var btnSend, btnSendChat, figurinesWrap;

  function getEl(id) { return document.getElementById(id); }
  function refs() {
    messagesInner = getEl('messagesInner');
    loadingBubble = getEl('loadingBubble');
    emptyState = getEl('emptyState');
    chatWrap = getEl('chatWrap');
    main = getEl('main');
    textInput = getEl('textInput');
    textInputChat = getEl('textInputChat');
    fileInput = getEl('fileInput');
    fileInputChat = getEl('fileInputChat');
    previewWrap = getEl('previewWrap');
    previewWrapChat = getEl('previewWrapChat');
    previewImg = getEl('previewImg');
    previewImgChat = getEl('previewImgChat');
    btnSend = getEl('btnSend');
    btnSendChat = getEl('btnSendChat');
    figurinesWrap = getEl('figurinesWrap');
  }

  function hasContent() {
    return state.messages.length > 0 || state.isLoading;
  }

  function setPlaceholder() {
    var step = state.step;
    var place = step === 'welcome' ? 'Опиши образ или прикрепи картинку...' : step === 'clarify_price' ? 'Выбери цену выше или напиши свой вариант' : step === 'clarify_occasion' ? 'Выбери повод выше или напиши' : 'Напиши сообщение...';
    if (textInput) textInput.placeholder = place;
    if (textInputChat) textInputChat.placeholder = place;
  }

  function addAssistantMessage(content, opts) {
    opts = opts || {};
    state.messages.push({
      id: 'msg-' + Date.now(),
      role: 'assistant',
      content: content,
      products: opts.products,
      masters: opts.masters,
      quickReplies: opts.quickReplies,
    });
    renderMessages();
    scrollToEnd();
  }

  function runSearch(prompt, imageUrl) {
    state.userDescription = prompt || state.userDescription;
    if (imageUrl) state.userImageUrl = imageUrl;
    state.isLoading = true;
    state.step = 'searching';
    renderMessages();
    setPlaceholder();
    scrollToEnd();

    setTimeout(function () {
      var products = mockSearch(prompt || state.userDescription || 'платье');
      state.isLoading = false;
      state.step = 'results';
      addAssistantMessage('Найдено ' + products.length + ' товаров. Посмотри, есть ли то что искал.', { products: products });
      addAssistantMessage('Нашёл ли ты то, что хотел?', {
        quickReplies: [
          { label: 'Да, нашёл', action: 'yes' },
          { label: 'Нет, не то', action: 'no' },
        ],
      });
      state.step = 'follow_up';
      setPlaceholder();
      scrollToEnd();
    }, 1200);
  }

  function handleQuickReply(action) {
    if (action === 'yes') {
      addAssistantMessage('Отлично! Если захочешь подобрать ещё образ — просто опиши, что ищешь.', { quickReplies: [{ label: 'Новый поиск', action: 'new_search' }] });
      state.step = 'welcome';
      state.userDescription = '';
      state.userFilters = {};
      setPlaceholder();
      toggleView();
      return;
    }
    if (action === 'new_search') {
      addAssistantMessage('Опиши, какой образ хочешь найти — начнём заново.');
      state.step = 'welcome';
      state.userDescription = '';
      state.userImageUrl = null;
      state.userFilters = {};
      state.selectedImage = null;
      setPlaceholder();
      toggleView();
      return;
    }
    if (action === 'no') {
      state.step = 'not_found';
      addAssistantMessage('Тогда можем помочь так:', {
        quickReplies: [
          { label: 'Найти мастера по пошиву', action: 'find_master' },
          { label: 'Сгенерировать картинку образа', action: 'generate_image' },
          { label: 'Новый поиск', action: 'new_search' },
        ],
      });
      setPlaceholder();
      renderMessages();
      scrollToEnd();
      return;
    }
    if (action === 'find_master') {
      addAssistantMessage('Подбор ателье под твой образ и бюджет. Примерная цена изделия:', { masters: MOCK_MASTERS });
      state.step = 'welcome';
      state.userDescription = '';
      state.userImageUrl = null;
      state.userFilters = {};
      toggleView();
      setPlaceholder();
      return;
    }
    if (action === 'generate_image') {
      addAssistantMessage('Генерация образа по описанию в разработке. Скоро можно будет получить картинку платья или образа по твоим пожеланиям.');
      state.step = 'welcome';
      state.userDescription = '';
      state.userImageUrl = null;
      state.userFilters = {};
      toggleView();
      setPlaceholder();
      return;
    }
    if (PRICE_OPTIONS.some(function (o) { return o.value === action; })) {
      state.userFilters.priceSegment = action;
      state.step = 'clarify_occasion';
      addAssistantMessage('Повод или тип образа?', { quickReplies: OCCASION_OPTIONS.map(function (o) { return { label: o.label, action: o.value }; }) });
      setPlaceholder();
      renderMessages();
      scrollToEnd();
      return;
    }
    if (OCCASION_OPTIONS.some(function (o) { return o.value === action; })) {
      state.userFilters.occasion = action;
      runSearch(state.userDescription, state.userImageUrl);
      return;
    }
  }

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function renderProductCard(product) {
    var imgs = (product.images && product.images.length) ? product.images : [product.image];
    var sim = product.similarity != null ? Math.round(product.similarity * 100) + '%' : '';
    var html = '<div class="card">';
    html += '<div class="card-image-wrap">';
    html += '<img src="' + escapeHtml(imgs[0]) + '" alt="" onerror="this.src=\'' + PLACEHOLDER_IMG.replace(/'/g, "\\'") + '\'">';
    if (sim) html += '<span class="card-badge">' + sim + '</span>';
    html += '<a href="' + escapeHtml(product.url) + '" target="_blank" rel="noopener noreferrer" class="card-link">↗</a>';
    html += '</div>';
    if (imgs.length > 1) {
      html += '<div class="card-thumbs">';
      imgs.slice(0, 5).forEach(function (src) {
        html += '<div class="card-thumb"><img src="' + escapeHtml(src) + '" alt=""></div>';
      });
      html += '</div>';
    }
    html += '<div class="card-body">';
    html += '<h4 class="card-title">' + escapeHtml(product.name) + '</h4>';
    if (product.brand) html += '<p class="card-brand">' + escapeHtml(product.brand) + '</p>';
    html += '<p class="card-price">' + product.price.toLocaleString('ru-RU') + ' ₽</p>';
    html += '</div></div>';
    return html;
  }

  function renderMasterCard(master) {
    var priceText = master.priceTo ? 'от ' + master.priceFrom.toLocaleString('ru-RU') + ' – ' + master.priceTo.toLocaleString('ru-RU') + ' ₽' : 'от ' + master.priceFrom.toLocaleString('ru-RU') + ' ₽';
    var html = '<div class="card">';
    html += '<div class="card-image-wrap"><img src="' + escapeHtml(master.image) + '" alt="" onerror="this.src=\'' + PLACEHOLDER_IMG.replace(/'/g, "\\'") + '\'"></div>';
    html += '<div class="card-body">';
    html += '<h4 class="card-title">' + escapeHtml(master.name) + '</h4>';
    html += '<p class="card-price" style="font-size:0.875rem;font-weight:400;color:var(--gray-600)">' + priceText + '</p>';
    html += '</div></div>';
    return html;
  }

  function renderMessages() {
    if (!messagesInner) return;
    messagesInner.innerHTML = '';
    state.messages.forEach(function (msg) {
      var wrap = document.createElement('div');
      wrap.className = 'msg ' + msg.role';
      var bubble = document.createElement('div');
      bubble.className = 'msg-bubble';
      var content = '<p class="msg-content">' + escapeHtml(msg.content) + '</p>';
      if (msg.imageUrl && msg.role === 'user') {
        content = '<div class="msg-image"><img src="' + escapeHtml(msg.imageUrl) + '" alt=""></div>' + content;
      }
      if (msg.products && msg.products.length) {
        var byMarket = {};
        msg.products.forEach(function (p) {
          var n = p.marketplace || 'Другие';
          if (!byMarket[n]) byMarket[n] = [];
          byMarket[n].push(p);
        });
        Object.keys(byMarket).forEach(function (name) {
          content += '<div class="cards-group"><h4 class="cards-group-title">' + escapeHtml(name) + '</h4>';
          content += '<div class="cards-grid">';
          byMarket[name].forEach(function (p) { content += renderProductCard(p); });
          content += '</div></div>';
        });
      }
      if (msg.masters && msg.masters.length) {
        content += '<div class="cards-group" style="margin-top:16px"><div class="cards-grid">';
        msg.masters.forEach(function (m) { content += renderMasterCard(m); });
        content += '</div></div>';
      }
      if (msg.quickReplies && msg.quickReplies.length) {
        var discount = msg.quickReplies.find(function (qr) { return qr.action === 'discounts'; });
        var rest = msg.quickReplies.filter(function (qr) { return qr.action !== 'discounts'; });
        content += '<div class="quick-replies">';
        content += '<div class="quick-replies-buttons">';
        rest.forEach(function (qr) {
          content += '<button type="button" class="quick-reply-btn" data-action="' + escapeHtml(qr.action) + '">' + escapeHtml(qr.label) + '</button>';
        });
        content += '</div>';
        if (discount) {
          content += '<div class="quick-reply-discount-wrap"><button type="button" class="quick-reply-discount-btn" data-action="discounts">' + escapeHtml(discount.label) + '</button></div>';
        }
        content += '</div>';
      }
      bubble.innerHTML = content;
      wrap.appendChild(bubble);
      messagesInner.appendChild(wrap);

      bubble.querySelectorAll('.quick-reply-btn, .quick-reply-discount-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          handleQuickReply(btn.getAttribute('data-action'));
        });
      });
    });
  }

  function scrollToEnd() {
    var end = document.getElementById('messagesEnd');
    if (end) end.scrollIntoView({ behavior: 'smooth' });
  }

  function toggleView() {
    var has = hasContent();
    if (main) main.classList.toggle('has-content', has);
    if (emptyState) emptyState.style.display = has ? 'none' : 'block';
    if (chatWrap) chatWrap.style.display = has ? 'flex' : 'none';
    if (loadingBubble) loadingBubble.style.display = (state.isLoading ? 'flex' : 'none');
    if (figurinesWrap) figurinesWrap.classList.toggle('figurines-hidden', has);
    var hasInput = !!(state.selectedImage || (textInput && textInput.value.trim()));
    var hasInputChat = !!(state.selectedImage || (textInputChat && textInputChat.value.trim()));
    if (btnSend) btnSend.disabled = state.isLoading || !hasInput;
    if (btnSendChat) btnSendChat.disabled = state.isLoading || !hasInputChat;
  }

  function handleSubmit(e, isChat) {
    var ev = e || {};
    if (ev.preventDefault) ev.preventDefault();
    if (ev.stopPropagation) ev.stopPropagation();
    var inputEl = isChat ? textInputChat : textInput;
    var text = (inputEl && inputEl.value.trim()) || '';
    if (!text && !state.selectedImage) return;

    var userMsg = {
      id: 'msg-' + Date.now(),
      role: 'user',
      content: text || 'Вот картинка',
      imageUrl: state.selectedImage || undefined,
    };
    state.messages.push(userMsg);

    if (state.step === 'welcome') {
      state.userDescription = text || 'по картинке';
      if (state.selectedImage) state.userImageUrl = state.selectedImage;
      if (inputEl) inputEl.value = '';
      state.selectedImage = null;
      state.step = 'clarify_price';
      addAssistantMessage('Понял! Уточни ценовой сегмент:', { quickReplies: PRICE_OPTIONS.map(function (o) { return { label: o.label, action: o.value }; }) });
      toggleView();
      setPlaceholder();
      scrollToEnd();
      updatePreviews();
      return;
    }
    if (state.step === 'clarify_price') {
      var priceOpt = PRICE_OPTIONS.find(function (o) { return o.label === text || o.value === text; });
      state.userFilters.priceSegment = (priceOpt && priceOpt.value) || 'mid';
      state.step = 'clarify_occasion';
      addAssistantMessage('Повод или тип образа?', { quickReplies: OCCASION_OPTIONS.map(function (o) { return { label: o.label, action: o.value }; }) });
      if (inputEl) inputEl.value = '';
      setPlaceholder();
      renderMessages();
      scrollToEnd();
      return;
    }
    if (state.step === 'clarify_occasion') {
      var occOpt = OCCASION_OPTIONS.find(function (o) { return o.label === text || o.value === text; });
      if (occOpt) state.userFilters.occasion = occOpt.value;
      runSearch(state.userDescription, state.userImageUrl);
      if (inputEl) inputEl.value = '';
      return;
    }
    if (inputEl) inputEl.value = '';
    state.selectedImage = null;
    updatePreviews();
    runSearch(text, state.selectedImage);
    return false;
  }

  function updatePreviews() {
    var has = !!state.selectedImage;
    if (previewWrap) previewWrap.style.display = has ? 'block' : 'none';
    if (previewWrapChat) previewWrapChat.style.display = has ? 'block' : 'none';
    if (has && previewImg) previewImg.src = state.selectedImage;
    if (has && previewImgChat) previewImgChat.src = state.selectedImage;
  }

  function onImageChange(file) {
    if (!file) return;
    var reader = new FileReader();
    reader.onloadend = function () {
      state.selectedImage = reader.result;
      updatePreviews();
    };
    reader.readAsDataURL(file);
  }

  function init() {
    try {
      refs();
      if (!btnSend && !getEl('inputForm')) {
        console.warn('StyleGenie: элементы формы не найдены.');
        return;
      }
      setPlaceholder();
      toggleView();

      var form1 = document.getElementById('inputForm');
      var form2 = document.getElementById('inputFormChat');
      if (form1) {
        form1.addEventListener('submit', function (e) { handleSubmit(e, false); return false; });
      }
      if (form2) {
        form2.addEventListener('submit', function (e) { handleSubmit(e, true); return false; });
      }

      // Кнопка «Отправить» — клик срабатывает даже если submit формы не сработал (например на GitHub Pages)
      if (btnSend) {
        btnSend.addEventListener('click', function (e) {
          e.preventDefault();
          handleSubmit(e, false);
          return false;
        });
      }
      if (btnSendChat) {
        btnSendChat.addEventListener('click', function (e) {
          e.preventDefault();
          handleSubmit(e, true);
          return false;
        });
      }

      if (document.getElementById('btnImage') && fileInput) {
        document.getElementById('btnImage').addEventListener('click', function () { fileInput.click(); });
      }
      if (document.getElementById('btnImageChat') && fileInputChat) {
        document.getElementById('btnImageChat').addEventListener('click', function () { fileInputChat.click(); });
      }
      if (fileInput) fileInput.addEventListener('change', function () { onImageChange(this.files[0]); });
      if (fileInputChat) fileInputChat.addEventListener('change', function () { onImageChange(this.files[0]); });

      var pr = document.getElementById('previewRemove');
      if (pr) pr.addEventListener('click', function () { state.selectedImage = null; updatePreviews(); });
      var prc = document.getElementById('previewRemoveChat');
      if (prc) prc.addEventListener('click', function () { state.selectedImage = null; updatePreviews(); });

      setInterval(function () {
        if (loadingBubble) loadingBubble.style.display = state.isLoading ? 'flex' : 'none';
        var hasInput = (textInput && textInput.value.trim()) || state.selectedImage;
        var hasInputChat = (textInputChat && textInputChat.value.trim()) || state.selectedImage;
        if (btnSend) btnSend.disabled = state.isLoading || !hasInput;
        if (btnSendChat) btnSendChat.disabled = state.isLoading || !hasInputChat;
      }, 200);
    document.body.setAttribute('data-stylegenie', 'ready');
    } catch (err) {
      console.error('StyleGenie init error:', err);
      document.body.setAttribute('data-stylegenie', 'error');
    }
  }

  window.__stylegenieDoSend = function (isChat) {
    try {
      refs();
      handleSubmit({ preventDefault: function () {}, stopPropagation: function () {} }, !!isChat);
    } catch (err) {
      console.error('StyleGenie send error:', err);
    }
    return false;
  };

  function run() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  }
  run();
})();
</script>
</body>
</html>
